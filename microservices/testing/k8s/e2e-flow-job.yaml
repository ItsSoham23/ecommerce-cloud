apiVersion: batch/v1
kind: Job
metadata:
  name: ecommerce-e2e-flow
  namespace: ecommerce
spec:
  template:
    metadata:
      name: ecommerce-e2e-flow
    spec:
      restartPolicy: Never
      containers:
      - name: e2e
        image: python:3.11-alpine
        command: ["/bin/sh","-c"]
        args:
        - |
          apk add --no-cache curl jq >/dev/null 2>&1 || true
          cat > /tmp/e2e.py <<'PY'
import json,sys,time,urllib.request,urllib.parse

BASE='http://aef3e087a2e7147bfbfba18e589d76e6-37607585.ap-south-1.elb.amazonaws.com'
def call(method,path,token=None,data=None):
    url=BASE+path
    headers={'Content-Type':'application/json'}
    if token:
        headers['Authorization']='Bearer '+token
    data_bytes=None
    if data is not None:
        data_bytes=json.dumps(data).encode('utf-8')
    req=urllib.request.Request(url,data=data_bytes,headers=headers,method=method)
    try:
        with urllib.request.urlopen(req,timeout=20) as resp:
            return resp.getcode(),json.loads(resp.read().decode('utf-8'))
    except urllib.error.HTTPError as e:
        try:
            body=e.read().decode('utf-8')
            return e.code,json.loads(body)
        except Exception:
            return e.code,{'error':str(e)}
    except Exception as ex:
        return None,{'error':str(ex)}

ts=int(time.time())
email=f'test+{ts}@example.com'
password='Pass123!'
print('=== REGISTER ===')
code,body=call('POST','/api/users',data={'email':email,'firstName':'Test','lastName':'User','password':password,'confirmPassword':password,'phone':'9999999999'})
print(code,body)
if not body or 'id' not in body:
    print('Registration failed, aborting'); sys.exit(1)
user_id=str(body.get('id'))

print('\n=== LOGIN ===')
code,body=call('POST','/api/users/login',data={'email':email,'password':password})
print(code,body)
token=body.get('accessToken')
if not token:
    print('Login failed, aborting'); sys.exit(1)

print('\n=== GET PRODUCTS ===')
code,body=call('GET','/api/products',token=token)
print(code,type(body))
products=body if isinstance(body,list) else body.get('items') or body.get('products') or body
try:
    pid=products[0]['id'] if isinstance(products,list) and products else None
except Exception:
    pid=None
print('product id:',pid)
if not pid:
    print('No product to add, aborting'); sys.exit(1)

print('\n=== ADD TO CART ===')
code,body=call('POST',f'/api/cart/{user_id}/items',token=token,data={'productId':pid,'quantity':1})
print(code,body)
if code is None or (isinstance(code,int) and code>=400):
    print('Add to cart failed, aborting'); sys.exit(1)

print('\n=== CREATE ORDER ===')
order_payload={'userId':user_id,'items':[{'productId':pid,'quantity':1}],'total':0}
code,body=call('POST','/api/orders',token=token,data=order_payload)
print(code,body)
order_id=body.get('orderId') or body.get('id') or body.get('orderId')
if not order_id:
    print('Order creation failed, aborting'); sys.exit(1)

print('\n=== SIMULATE PAYMENT (succeeded) ===')
pay_payload={'orderId':order_id,'amount':0,'userId':user_id,'simulate':'succeeded'}
code,body=call('POST','/api/payments',token=token,data=pay_payload)
print(code,body)

print('\n=== FETCH ORDER TO VERIFY STATUS ===')
code,body=call('GET',f'/api/orders/{order_id}',token=token)
print(code,body)
print('\nE2E script completed')
PY
          sed -i 's/^\s\{0,10\}//' /tmp/e2e.py || true
          python /tmp/e2e.py
      
  backoffLimit: 0
