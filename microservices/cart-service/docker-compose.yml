services:
  localstack:
    image: localstack/localstack:latest
    container_name: cart-localstack
    environment:
      SERVICES: dynamodb
      DEBUG: 1
    ports:
      - "4567:4566"
    volumes:
      - ./localstack-data:/var/lib/localstack
      - /var/run/docker.sock:/var/run/docker.sock
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  cart-service:
    build: .
    image: cart-service:latest
    container_name: cart-service-app
    ports:
      - "8083:8083"
    environment:
      NODE_ENV: development
      PORT: 8083
      USE_LOCALSTACK: "true"
      # Use the local localstack service available in this compose project
      LOCALSTACK_ENDPOINT: http://localstack:4566
      AWS_REGION: us-east-1
      DYNAMODB_TABLE: Carts
      PRODUCT_SERVICE_URL: http://host.docker.internal:8082
      KAFKA_BROKERS: host.docker.internal:9092
    depends_on:
      localstack:
        condition: service_healthy
    restart: on-failure
    extra_hosts:
      - "host.docker.internal:host-gateway"